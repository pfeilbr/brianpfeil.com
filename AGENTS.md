# AGENTS.md — Project Context for AI Agents

## Overview

This is a personal blog (brianpfeil.com) built with Hugo. There is no external theme — all layouts live in `layouts/`. The site has ~310 blog posts (282 auto-generated from GitHub repos, ~30 manual), plus project pages and an about page.

## Architecture

### Hugo (Static Site Generator)
- Config: `config.yaml` — no theme reference, layouts are in root `layouts/`
- Goldmark markdown renderer with `unsafe: true` (allows raw HTML in posts)
- `disablePathToLower: true` — preserves URL casing
- `buildFuture: true` — includes posts with future dates

### CSS Pipeline
- Plain CSS utility classes (no build tools, no preprocessors)
- Entry point: `assets/css/main.css` (reset + utility classes + prose styles)
- Syntax highlighting: `assets/css/syntax.css` (Chroma, trac style)
- In `baseof.html`: `slice $main $syntax | resources.Concat "css/bundle.css" | minify | fingerprint`
- No Node.js, npm, or PostCSS required

### JavaScript
- Zero JS frameworks. All vanilla JS.
- `assets/js/search.js` — client-side search (fetches `/index.json`, term-matching, debounced)
- Inline JS in `layouts/index.html` — infinite scroll (IntersectionObserver), back-to-top, "/" shortcut, click delegation
- Dark mode via DarkReader (CDN script in `baseof.html`, localStorage persistence)

### Post Generation Tool
- `tools/generate-posts/` — Go CLI that creates blog posts from GitHub repo READMEs
- Fetches repos via GitHub API, filters by regex, converts relative links to absolute
- Config: `tools/generate-posts/config.yaml` (checked in) + `config.local.yaml` (gitignored, has GitHub token)
- Run via: `./site generate-posts-from-repos` or `make generate-posts`

## Template Hierarchy

```
layouts/_default/baseof.html     <- HTML shell, CSS bundle, Google Fonts, DarkReader, dark mode JS
  layouts/partials/nav.html      <- Responsive nav, <details> for mobile, dark mode toggle icons
  layouts/partials/footer.html   <- Social links (Twitter, GitHub, Stack Overflow, RSS)
  layouts/partials/search.html   <- Sticky search bar, <template> for results, loads search.js

  layouts/index.html             <- Homepage: search + paginated post list + infinite scroll
  layouts/_default/single.html   <- Individual post/page (hides date on layout="page")
  layouts/_default/list.html     <- Tags taxonomy page (pills) + term pages (post lists)
  layouts/projects/list.html     <- Projects section (card grid)
  layouts/_default/index.json    <- JSON search index for client-side search
```

## Key Conventions

### URLs
- **Always use `.RelPermalink`** for internal links (not `.Permalink`)
- Exception: canonical link in `<head>` and RSS `<link>` use absolute URLs
- The render hook (`layouts/_default/_markup/render-link.html`) adds `target="_blank"` to external links (starting with "http")

### Hugo Taxonomy Kinds
- `"taxonomy"` = the listing page (e.g., `/tags/`) — shows all tags
- `"term"` = an individual term page (e.g., `/tags/aws/`) — shows posts for that tag
- **Not** `"terms"` — that's the old Hugo naming

### Pagination
- `pagerSize: 30` in config.yaml (use `PagerSize` not deprecated `PageSize`)
- Homepage uses infinite scroll (IntersectionObserver), not pagination links

### Homepage Post List
- Each post is an `<article>` with `data-href` attribute
- Click delegation JS handles row clicks while allowing nested `<a>` tags (for tags) to work independently
- Shows: title + date ("Jan 2006" format) + up to 3 tags

### Generated Posts (282 files)
- Filename pattern: `content/post/generated-*.md`
- **Do NOT bulk-modify these files** — they are regenerated by the Go tool
- They contain legacy Bootstrap/Font Awesome HTML in the "code for article" banner:
  ```html
  <div class="alert alert-info small bg-info" role="alert">
  <span class="text-muted">code for article</span>&nbsp;<a href="..."><i class="fab fa-github fa-sm"></i>&nbsp;...</a>
  </div>
  ```
- This HTML is restyled via CSS rules in `assets/css/main.css` using `:has(> .text-muted)` and CSS mask-image for the GitHub icon

### Pages with `layout = "page"`
- `content/about.md` uses `layout = "page"` in front matter
- `single.html` hides the date and tags for these pages

## File Relationships

| If you change... | Also check... |
|------------------|---------------|
| `config.yaml` (menu items) | `layouts/partials/nav.html` |
| `config.yaml` (mainSections) | `layouts/index.html` (post query), `layouts/_default/index.json` |
| `assets/css/main.css` (utility classes) | All layout templates that use those classes |
| `layouts/partials/search.html` | `assets/js/search.js`, `layouts/_default/index.json` |
| `layouts/index.html` (post list structure) | `assets/js/search.js` (search result template should match) |
| `tools/generate-posts/templates/post.md` | `assets/css/main.css` (backward-compat CSS for banner HTML) |

## Common Tasks

### Add a new blog post
```bash
./site post -t "My Post Title"
# Edit content/post/my-post-title/index.md
make dev  # Preview
```

### Regenerate posts from GitHub repos
```bash
make generate-posts
```

### Run the dev server
```bash
make dev  # or: ./site run-local
```

### Build for production
```bash
make build  # hugo --minify
```

### Run Go tool tests
```bash
make test-tools  # cd tools/generate-posts && go test ./...
```

## Gotchas and Pitfalls

1. **`PagerSize` not `PageSize`** — deprecated in Hugo v0.128+
2. **Taxonomy kind is `"taxonomy"` not `"terms"`** — Hugo renamed this
3. **`grep -P` doesn't work on macOS** — use alternative patterns in scripts
4. **Hugo box-drawing chars in output** — `hugo --minify` output uses Unicode box chars, not plain text; grep carefully in scripts
5. **The 282 generated posts have a trailing comma in tags** — `tags = ["aws","alexa",]` — Hugo tolerates it, don't worry about it
6. **DarkReader must call `setFetchMethod(window.fetch)`** — required for the CDN version to work
7. **Search hides the scroll sentinel** — when searching, the infinite scroll sentinel is hidden; when cleared, it reappears

## Build and Deploy

- **Local**: `make dev` -> Hugo dev server at localhost:1313
- **CI**: GitHub Actions (`.github/workflows/gh-pages.yml`) -> Hugo build -> GitHub Pages
- **Domain**: `brianpfeil.com` via CNAME in `static/CNAME`
- Posts are generated locally and committed; CI only builds Hugo
