# AGENTS.md — Project Context for AI Agents

## Overview

Personal blog ([brianpfeil.com](https://brianpfeil.com)) built with Hugo. No external theme — all layouts are in `layouts/`. The site has blog posts (most auto-generated from GitHub repos, the rest manual), project pages, and an about page.

## Project Structure

```
.
├── config.yaml                        # Hugo config (no theme reference)
├── Makefile                           # dev, build, generate-posts, test-tools
├── AGENTS.md
├── README.md
├── .github/workflows/gh-pages.yml     # CI: Hugo build → GitHub Pages
├── assets/
│   ├── css/main.css                   # Single CSS file (reset + utilities + prose + syntax)
│   └── js/search.js                   # Client-side search (vanilla JS)
├── content/
│   ├── about.md                       # layout = "page" (hides date/tags)
│   ├── post/
│   │   ├── generated-*.md             # Auto-generated by Go tool — DO NOT hand-edit
│   │   ├── *.md                       # Manual posts (flat files)
│   │   └── {slug}/index.md            # Manual posts (page bundles with local images)
│   └── projects/
│       ├── _index.md                  # Section index
│       └── {project}/index.md         # Individual project pages
├── layouts/
│   ├── _default/baseof.html           # HTML shell, CSS bundle, Google Fonts, DarkReader
│   ├── _default/single.html           # Individual post/page
│   ├── _default/list.html             # Tags taxonomy + term pages
│   ├── _default/index.json            # JSON search index
│   ├── _default/_markup/render-link.html  # Adds target="_blank" to external links
│   ├── index.html                     # Homepage: search + post list + infinite scroll
│   ├── projects/list.html             # Projects card grid
│   └── partials/
│       ├── nav.html                   # Responsive nav, dark mode toggle
│       ├── footer.html                # Social links (Twitter, GitHub, SO, RSS)
│       └── search.html                # Sticky search bar + <template> + loads search.js
├── static/images/                     # Static images served as-is
└── tools/generate-posts/              # Go CLI — generates posts from GitHub READMEs
    ├── main.go                        # Entry point, CLI flags
    ├── config.go                      # Config loading (config.yaml + config.local.yaml)
    ├── github.go                      # GitHub API client, repo fetching, README download
    ├── post.go                        # Post building: title, tags, slug, rendering
    ├── links.go                       # Relative → absolute link rewriting
    ├── *_test.go                      # Tests for post titles, slugs, link rewriting
    ├── templates/post.md              # Go template for generated post output
    ├── config.yaml                    # Repo filters, title mappings, casing, tag rules
    ├── config.local.yaml              # Gitignored — GitHub token goes here
    └── testdata/                      # Test fixtures with expect.json + sample READMEs
```

## Architecture

### Hugo Configuration (`config.yaml`)

- Goldmark markdown renderer with `unsafe: true` (allows raw HTML in posts)
- `disablePathToLower: true` — preserves URL casing
- `buildFuture: true` — includes posts with future dates
- `mainSections: ["post", "posts"]` — controls which sections appear on homepage
- Outputs: HTML + RSS + JSON (search index) for home

### CSS Pipeline

- Single plain CSS file: `assets/css/main.css`
- Tailwind-like utility classes hand-written (no Tailwind dependency)
- Prose styles for post content (`.prose h1`, `.prose p`, `.prose code`, etc.)
- Chroma syntax highlighting (trac style)
- In `baseof.html`: `resources.Get "css/main.css" | minify | fingerprint`
- No Node.js, npm, or PostCSS required
- Brand color: `#0d7ea8`

### JavaScript

- Zero frameworks. All vanilla JS.
- `assets/js/search.js` — client-side search against `/index.json`
  - Scoring: title match (10 pts) > tag match (5 pts) > content match (1 pt)
  - 300ms debounce on input
- Inline JS in `layouts/index.html`:
  - Infinite scroll via IntersectionObserver (loads paginated pages via fetch)
  - Back-to-top button (appears after 400px scroll)
  - "/" keyboard shortcut to focus search
  - Click delegation on `[data-href]` article rows
- Dark mode via DarkReader CDN in `baseof.html`, persisted to localStorage

### Post Generation Tool (`tools/generate-posts/`)

Go CLI that creates blog posts from GitHub repo READMEs.

**Data flow:**
1. Load config (`config.yaml` merged with `config.local.yaml`)
2. Fetch all repos for user via GitHub API (paginated, 100/page)
3. Filter repos by include/exclude regex patterns
4. For each matching repo:
   - Fetch README.md from raw GitHub CDN
   - Strip any existing frontmatter and first H1
   - Convert relative links to absolute GitHub URLs (see link rewriting below)
   - Generate title from repo name (with explicit mappings → casing corrections → title case)
   - Build tags from: auto-tags by repo name keywords + per-repo mappings + README frontmatter tags
   - Deduplicate and normalize tags (e.g., `c++` → `cpp`, `js` → `javascript`)
   - Render via `templates/post.md` (TOML frontmatter + HTML banner + markdown body)
   - Write to `content/post/generated-{repo-name}.md`

**Link rewriting rules (`links.go`):**
- Image files (.png, .jpg, .gif, .svg, .webp) → `raw.githubusercontent.com` (direct rendering)
- Other files → `github.com/{repo}/blob/{branch}/` (browser navigation)
- Absolute URLs, anchors (#), mailto: links → unchanged
- Handles markdown links `[text](path)`, images `![alt](path)`, and HTML `<img src="path">`
- Branch comes from the GitHub API per-repo; falls back to config `default_branch` (default: `"main"`)

**CLI flags:** `-user` (GitHub username), `-dest` (output dir), `-cache` (cache repo list), `-debug`

**Config structure (`tools/generate-posts/config.yaml`):**
- `repo_filters.include/exclude` — regex patterns to select/skip repos
- `title_mappings` — explicit title overrides for specific repos
- `casing_corrections` — words needing specific casing (AWS, CDK, TypeScript, etc.)
- `tags.auto_from_repo_name` — keywords auto-extracted if found in repo name
- `tags.repo_mappings` — per-repo tag overrides
- `tags.normalize` — tag renaming rules
- `tags.static` — tags added to all posts (currently empty)

**Dependencies:** `google/go-github`, `golang.org/x/oauth2`, `adrg/frontmatter`, `gopkg.in/yaml.v3`, `golang.org/x/text`

## Content Conventions

### Generated Posts

- Filename: `content/post/generated-{repo-name}.md`
- **Do NOT hand-edit** — they are fully regenerated by the Go tool
- TOML frontmatter with fields: `author`, `categories` (repo language + "playground"), `date` (repo creation date), `slug`, `tags`, `title`, `repoFullName`, `repoHTMLURL`, `truncated = true`, `summary = " "` (single space)
- HTML banner after frontmatter (legacy Bootstrap/Font Awesome markup):
  ```html
  <div class="alert alert-info small bg-info" role="alert">
  <span class="text-muted">code for article</span>&nbsp;<a href="..."><i class="fab fa-github fa-sm"></i>&nbsp;...</a>
  </div>
  ```
- This HTML is restyled via CSS in `main.css` using `:has(> .text-muted)` and CSS `mask-image` for the GitHub icon
- Tags have a trailing comma (`["aws","alexa",]`) — Hugo tolerates this

### Manual Posts

- Flat files (`content/post/{slug}.md`) or page bundles (`content/post/{slug}/index.md`)
- Page bundles allow co-located images referenced with relative paths
- Frontmatter varies — no strict template, but typically includes: `title`, `date`, `tags`, `categories`, `slug`, `author`, `summary`

### Pages with `layout = "page"`

- `content/about.md` uses `layout = "page"` in front matter
- `single.html` hides the date and tags for these pages

## Key Conventions

### URLs

- **Always use `.RelPermalink`** for internal links (not `.Permalink`)
- Exception: canonical `<link>` in `<head>` and RSS `<link>` use absolute URLs
- The render hook (`render-link.html`) adds `target="_blank" rel="noopener noreferrer"` to external links (URLs starting with "http")

### Hugo Taxonomy Kinds

- `"taxonomy"` = the listing page (e.g., `/tags/`) — shows all tags as pills
- `"term"` = an individual term page (e.g., `/tags/aws/`) — shows posts with that tag
- **Not** `"terms"` — that's the old Hugo naming

### Pagination

- `pagerSize: 30` in config.yaml (use `PagerSize` not deprecated `PageSize`)
- Homepage uses infinite scroll (IntersectionObserver), not pagination links
- Tag term pages use standard prev/next pagination links

### Homepage Post List

- Each post is an `<article>` with `data-href` attribute
- Click delegation JS handles row clicks while allowing nested `<a>` tags (for tags) to work independently
- Shows: title + date ("Jan 2006" format) + up to 3 tags
- Search hides the post list and scroll sentinel; clearing search restores them

## File Relationships

| If you change... | Also check... |
|------------------|---------------|
| `config.yaml` (menu items) | `layouts/partials/nav.html` |
| `config.yaml` (mainSections) | `layouts/index.html` (post query), `layouts/_default/index.json` |
| `assets/css/main.css` (utility classes) | All layout templates that use those classes |
| `layouts/partials/search.html` | `assets/js/search.js`, `layouts/_default/index.json` |
| `layouts/index.html` (post list structure) | `assets/js/search.js` (search result template should match) |
| `tools/generate-posts/templates/post.md` | `assets/css/main.css` (banner restyling rules) |
| `tools/generate-posts/config.yaml` | Generated post output (titles, tags, filtering) |

## Common Tasks

### Add a new blog post
```bash
hugo new post/my-post-title/index.md
# Edit content/post/my-post-title/index.md
make dev  # Preview at localhost:1313
```

### Regenerate posts from GitHub repos
```bash
make generate-posts
```

### Run the dev server
```bash
make dev
```

### Build for production
```bash
make build  # hugo --minify
```

### Run Go tool tests
```bash
make test-tools  # cd tools/generate-posts && go test ./...
```

## Gotchas and Pitfalls

1. **`PagerSize` not `PageSize`** — `PageSize` is deprecated in Hugo v0.128+
2. **Taxonomy kind is `"taxonomy"` not `"terms"`** — Hugo renamed this
3. **`grep -P` doesn't work on macOS** — use alternative patterns in scripts
4. **Hugo box-drawing chars in output** — `hugo --minify` output uses Unicode box chars; grep carefully in scripts
5. **Generated posts have trailing comma in tags** — `tags = ["aws","alexa",]` — Hugo tolerates it, don't worry about it
6. **DarkReader must call `setFetchMethod(window.fetch)`** — required for the CDN version to work
7. **Search hides the scroll sentinel** — when searching, the infinite scroll sentinel is hidden; when cleared, it reappears
8. **Generated posts are idempotent** — the Go tool fully controls their content; manual edits will be overwritten on next run
9. **`config.local.yaml` is gitignored** — GitHub token lives there, never in `config.yaml`

## Build and Deploy

- **Local**: `make dev` → Hugo dev server at localhost:1313 (with live reload, drafts enabled)
- **CI**: GitHub Actions (`.github/workflows/gh-pages.yml`) → triggers on push to `main` → `hugo --minify` → deploys to GitHub Pages
- **Domain**: `brianpfeil.com` (configured in GitHub Pages repo settings)
- Posts are generated locally and committed; CI only runs the Hugo build
